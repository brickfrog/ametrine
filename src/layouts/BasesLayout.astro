---
import { getPublishedNotes } from '../utils/filterNotes';
import BaseLayout from './BaseLayout.astro';
import { Search } from '../components/react/Search';
import { ScrollToTop } from '../components/react/ScrollToTop';
import { MobileNav } from '../components/react/MobileNav';
import { LinkPreviewManager } from '../components/react/LinkPreviewManager';
import QuickActions from '../components/QuickActions.astro';
import Explorer from '../components/Explorer.astro';
import Divider from '../components/Divider.astro';
import Footer from '../components/Footer.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import SidebarHeader from '../components/SidebarHeader.astro';
import { config } from '../config';

interface Props {
  title: string;
  description?: string;
  slug: string;
  hideBreadcrumbs?: boolean;
}

const { title, description, slug, hideBreadcrumbs = false } = Astro.props;
const allNotes = await getPublishedNotes();

const baseHref = import.meta.env.BASE_URL ?? "/";
const trimmedBase = baseHref.endsWith("/") ? baseHref.slice(0, -1) : baseHref;
const basePath = trimmedBase === "/" ? "" : trimmedBase;
const logoPath = config.logo?.replace(/^\/+/g, "");
const logoSrc = logoPath ? `${basePath}/${logoPath}` : undefined;
---

<BaseLayout title={title} description={description} slug={slug}>
  <MobileNav client:load>
    <SidebarHeader
      title={config.pageTitle}
      logo={logoSrc}
      logoAlt={config.logoAlt}
      baseHref={baseHref}
      showLogo={config.showSidebarLogo}
      useTitleAsAscii={config.renderTitleAsAscii}
      asciiArt={config.asciiArt}
    />
    <div class="my-1">
      <Search client:load />
    </div>
    <QuickActions />
    <Divider />
    <Explorer />
  </MobileNav>

  <div class="flex min-h-screen bg-theme-light">
    <aside class="w-64 hidden lg:block bg-theme-light">
      <div class="sticky top-0 p-6 space-y-6">
        <SidebarHeader
          title={config.pageTitle}
          logo={logoSrc}
          logoAlt={config.logoAlt}
          baseHref={baseHref}
          showLogo={config.showSidebarLogo}
          useTitleAsAscii={config.renderTitleAsAscii}
          asciiArt={config.asciiArt}
        />
        <div class="my-1">
          <Search client:load />
        </div>
        <QuickActions />
        <Divider />
        <Explorer />
      </div>
    </aside>

    <main class="flex-1 w-full overflow-x-hidden">
      {!hideBreadcrumbs && (
        <div class="px-4 sm:px-6 lg:px-8 pt-12 mb-4">
          <Breadcrumbs slug={slug} allNotes={allNotes} />
        </div>
      )}
      <slot />
      <div class="px-4 sm:px-6 lg:px-8">
        <Footer />
      </div>
    </main>

    <aside class="w-80 hidden xl:block bg-theme-light">
      <div class="sidebar-scroll sticky top-0 max-h-screen overflow-y-auto p-6">
      </div>
    </aside>
  </div>

  <ScrollToTop client:idle />
  <LinkPreviewManager client:only="react" transition:persist="link-preview-manager" />
</BaseLayout>
