---
import { render } from 'astro:content';
import ContentLayout from '../layouts/ContentLayout.astro';
import ContentMeta from '../components/ContentMeta.astro';
import Graph from '../components/Graph.astro';
import TableOfContents from '../components/TableOfContents.astro';
import Marginalia from '../components/Marginalia.astro';
import Tags from '../components/Tags.astro';
import LinksAndContext from '../components/LinksAndContext.astro';
import { config } from '../config';
import { getPublishedNotes } from '../utils/filterNotes';

// Try to get the index note if it exists
const notes = await getPublishedNotes();
const indexNote = notes.find(note => note.slug === 'index');

let IndexContent: any = null;
let indexToc: any[] = [];
let indexMarginalia: any[] = [];

if (indexNote) {
  const rendered = await render(indexNote);
  IndexContent = rendered.Content;
  indexToc = rendered.remarkPluginFrontmatter?.toc || [];
  indexMarginalia = rendered.remarkPluginFrontmatter?.marginalia || [];
}

const hasNotes = notes.length > 0;
---

{indexNote ? (
  <ContentLayout
    title={indexNote.data.title || indexNote.slug}
    description={indexNote.data.description}
    slug={indexNote.slug}
    marginalia={indexMarginalia}
    isFolder={false}
  >
    <h1 class="mb-0">{indexNote.data.title || indexNote.slug}</h1>
    <ContentMeta frontmatter={indexNote.data} content={indexNote.body || ""} />
    <div class="markdown-content">
      <IndexContent />
    </div>

    <Marginalia marginalia={indexMarginalia} />

    {config.linksAndContext?.enable && (
      <LinksAndContext note={indexNote} slug={indexNote.slug} />
    )}

    <div slot="right" class="space-y-6">
      <Graph currentSlug={indexNote.slug} instance="desktop" />
      <TableOfContents toc={indexToc} slug={indexNote.slug} />
      {config.tags?.enable && config.tags?.showInSidebar && indexNote.data.tags && (
        <Tags tags={Array.isArray(indexNote.data.tags) ? indexNote.data.tags : []} variant="sidebar" />
      )}
    </div>

    <div slot="mobile-bottom">
      <Graph currentSlug={indexNote.slug} instance="mobile" />
    </div>
  </ContentLayout>
) : (
  <ContentLayout
    title={config.pageTitle}
    description={config.defaultDescription}
    slug=""
    marginalia={[]}
    isFolder={false}
  >
    <div class="space-y-8">
      <div class="text-center space-y-4 py-12">
        <h1 class="text-4xl font-bold font-header text-theme-dark">
          {config.pageTitle}
        </h1>
        {config.defaultDescription && (
          <p class="text-xl text-theme-darkgray max-w-2xl mx-auto">
            {config.defaultDescription}
          </p>
        )}
      </div>

      {!hasNotes && (
        <div class="text-center py-12 text-theme-darkgray">
          <p>No notes yet. Add content to get started.</p>
        </div>
      )}
    </div>

    <div slot="right" class="space-y-6">
    </div>
  </ContentLayout>
)}
